<script type="text/x-kendo-template" id="registration2">
    <div class="LogoBig">
        <img src="images/MediRecordsIcon.png" />
    </div>
    <div class="registrationMessage">
        <p class="HeadMessage">
            Enter your Practice Detail
        </p>
    </div>
    <div class="triangle">
        <img src="images/triangleBorderGray.png" />
    </div>
    <div id="stylized" class="formFrame">
        <div style="margin: auto;">
            <div id="RegistrationForm">
                <table id="form" class="RegistrationTable" style="width:80%; margin: auto;">
                    <tr>
                        <td>
                            <input id="HiddenCurrentClinicalSystem" data-bind="value: currentClinicalSystem" hidden="true" class="HiddenField"/>
                            <input id="HiddenEmail" data-bind="value: email" hidden="true" class="HiddenField"/>
                            <input id="HiddenFirstName" data-bind="value: firstName" hidden="true" class="HiddenField"/>
                            <input id="HiddenLastName" data-bind="value: lastName" hidden="true" class="HiddenField"/>
                            <input id="HiddenPromotionCode" data-bind="value: promotionCode" hidden="true" class="HiddenField"/>
                            <input id="HiddenTitle" data-bind="value: title" hidden="true" class="HiddenField"/>
                            <input id="HiddenUserID" data-bind="value: userId" hidden="true" class="HiddenField"/>
                            <input id="HiddenAccountID" hidden="true" class="HiddenField"/>
							<input id="HiddenUserCategoryId" data-bind="value: userCategoryId" hidden="true" class="HiddenField"/>
							<input id="HiddenDoNotSendMM" data-bind="value: doNotSendMM" hidden="true" class="HiddenField"/>
							<input id="HiddenOpportunityGuid" data-bind="value: opportunityGuid" hidden="true" class="HiddenField"/>
							<input id="HiddenContactGuid" data-bind="value: contactGuid" hidden="true" class="HiddenField"/>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="PracticeName" placeholder="Practice Name" class='RegInputWithValidation' name="Practice Name" required data-bind="value: practiceName"/>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="Address1" placeholder="Address 1*" class='RegInputWithValidation' name="Address 1" required/>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="Address2" placeholder="Address 2" class='RegInputWithValidation'/>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="PostCode" placeholder="Post code*" class='RegInputWithValidation' name="Postal Code" required/>
                            <div class="k-invalid-msg" data-for="Postal Code"></div>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="CitySuburb" placeholder="City/ Suburb" class='RegistrationInput' name="Suburb" required/>
                            <div class="k-invalid-msg" data-for="Suburb"></div>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="State" placeholder="State" class='RegistrationInput' name="State" required/>
                            <div class="k-invalid-msg" data-for="State"></div>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="Country" placeholder="Country" class='RegistrationCombobox' name="Country" required/>
                            <div class="k-invalid-msg" data-for="Country"></div>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="Phone" type="tel" pattern="\d{10}" validationMessage="Please enter a ten digit phone number, must include prefix, no spaces and parenthesis. valid number is 0299604156." placeholder="Phone" class='RegistrationInput' name="Phone" required data-bind="value: phone"/>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
							<input id="ServiceProviderType" name="Service Provider Type" placeholder="Service Provider Type" class='RegistrationInput' required/>
                            <div class="k-invalid-msg" data-for="Service Provider Type"></div>  
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="NoofDoctor" placeholder="Number of Doctors*" class='RegistrationInput' name="No. of Doctors" required/>
                            <div class="k-invalid-msg" data-for="No. of Doctors"></div>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <input id="Reg2TimeZone" placeholder="Time Zone*" class='RegistrationCombobox' name="Time Zone" required/>
                            <div class="k-invalid-msg" data-for="Time Zone"></div>
                        </td>
                    </tr>
                    <tr class="RegistrationRow">
                        <td>
                            <table style="width:100%;">
                                <tr>
                                    <td style="text-align: left;">
                                    </td>
                                    <td style="text-align: right;">
                                        <input id="Reg2Next" value="Next" type="submit" class="MediRecordsButton" style="width: 70px;"/>        
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                </table>
                
            </div>    
        </div>
    </div>
    
</script>
<script>
    var accountGuid = "";

    var getRegId = function () { // parse for RegID from url
        var array = window.location.href.split('/');
        var regId = array[array.length - 1];
        return regId;
    };

    $(document).bind("viewSwtichedEvent", function (e, args) {
    	
    	if (document.getElementById('Address1') != null) {
            document.getElementById('Address1').focus();
        };

        function ApplyFieldLimitonReg2() {
            $.cookie.json = true;
            if (document.getElementById('PracticeName') != null) {
                //document.getElementById('PracticeName').maxLength = $.cookie('listOfFieldLimit').PracticeName;
            };
            if (document.getElementById('Address1') != null) {
                //document.getElementById('Address1').maxLength = $.cookie('listOfFieldLimit').Address;
            };
            if (document.getElementById('Address2') != null) {
                //document.getElementById('Address2').maxLength = $.cookie('listOfFieldLimit').Address;
            };
            if (document.getElementById('PostCode') != null) {
                //document.getElementById('PostCode').maxLength = $.cookie('listOfFieldLimit').PostCode;
            };
            if (document.getElementById('Phone') != null) {
                //document.getElementById('Phone').maxLength = $.cookie('listOfFieldLimit').Phone;
            };
        };
        ApplyFieldLimitonReg2();

        $('#CitySuburb').prop('disabled', true);
        $('#State').prop('disabled', true);


        $("#PostCode").change(function () {
            if ($("#PostCode").val() != "") {
                $("#CitySuburb").attr("class", "RegistrationCombobox");
                $('#CitySuburb').prop('disabled', false);
                SetSuburbByPostCode($("#PostCode").val());
                
                var suburbDropDown = $("#CitySuburb").data("kendoDropDownList");
                suburbDropDown.focus();
            };
        });

        function SetSuburbByPostCode(postCode) {
            var suburbDataSource = [
               						{Locality: "SYDNEY", PostCodeGUID: "685EC68C-FA00-474C-91B2-42AB59EEAE95"}
            					];
            
            $("#CitySuburb").kendoDropDownList({
                dataSource: suburbDataSource,
                dataTextField: "Locality",
                dataValueField: "PostCodeGUID",
                filter: "contains",
                suggest: true,
                optionLabel: "Suburb*"
            });
            
            $("#State").attr("class", "RegistrationCombobox");
            $('#State').prop('disabled', false);
            SetStateByPostCode($("#PostCode").val());
        };

        function SetStateByPostCode(postCode) {
            var stateDataSource = [
           						{StateName: "NSW", StateID: "685EC68C-FA00-474C-91B2-42AB59EEAE95"},
           						{StateName: "NSW2", StateID: "18B0A81E-35FC-4DE0-A5C0-5B19556439E5"},
           						{StateName: "NSW3", StateID: "138D7F3B-FCE2-494F-982C-A46F056CB066"},
           						{StateName: "NSW4", StateID: "3C9B8C9E-7081-4BAD-97BA-E64C670430FE"},
           						{StateName: "NSW5", StateID: "A2533EB7-AD4E-4D48-860C-6B8DA3C96732"}
        					];
            
            $("#State").kendoDropDownList({
                dataSource: stateDataSource,
                dataTextField: "StateName",
                dataValueField: "StateID",
                filter: "contains",
                suggest: true,
                optionLabel: "State*"
            });
        };

        function LoadDropDownLists() {

            $("#NoofDoctor").attr("class", "RegistrationCombobox");
            $("#ServiceProviderType").attr("class", "RegistrationCombobox");

            //define datasource for combobox TypeofPractice
            var ServiceProviderTypeDataSource = [
						{LOOKUPTEXT: "Aged Care Facility", LOOKUPGUID: "751A5990-9942-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Community Health", LOOKUPGUID: "718D7D74-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Dietitians", LOOKUPGUID: "9C5CFC7A-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Excercise Physiologist", LOOKUPGUID: "8B073689-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "General Practice", LOOKUPGUID: "CB03C58F-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Government Health", LOOKUPGUID: "CC39FF96-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Government Healthcare Department", LOOKUPGUID: "CDCD8003-5E40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Medicare Local Office", LOOKUPGUID: "90FCD89F-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Obstetrics & Gynaecology", LOOKUPGUID: "C51DA1AB-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Optometrist", LOOKUPGUID: "BC6D6FB6-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Orthapedics", LOOKUPGUID: "E185E7BC-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Pathology", LOOKUPGUID: "E285E7BC-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Pharmacy", LOOKUPGUID: "D4F1F1D5-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Physiotherapy", LOOKUPGUID: "2013FDDD-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Private Hospital", LOOKUPGUID: "9D95D9E4-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Psychiatry", LOOKUPGUID: "793764EE-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Public Hospital", LOOKUPGUID: "D8C909F5-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Radiology", LOOKUPGUID: "D9C909F5-5D40-E311-93F5-005056813643"},
						{LOOKUPTEXT: "Specialists", LOOKUPGUID: "FFAC9883-9942-E311-93F5-005056813643"}
					];

            //define datasource for combobox NoofDoctor
            var noofDoctorDataSource = [
                       { LOOKUPTEXT: "1-3", LOOKUPVALUE: "315890000"},
                       { LOOKUPTEXT: "4-7", LOOKUPVALUE: "315890001"},
                       { LOOKUPTEXT: "8-15", LOOKUPVALUE: "315890002"},
                       { LOOKUPTEXT: "15-25", LOOKUPVALUE: "315890003"},
                       { LOOKUPTEXT: "25+", LOOKUPVALUE: "315890004"}
                   ];

            //assign combobox NoofDoctor with value from datasource
            $("#NoofDoctor").kendoDropDownList({
                dataSource: noofDoctorDataSource,
                dataTextField: "LOOKUPTEXT",
                dataValueField: "LOOKUPVALUE",
                optionLabel: "Number of Doctors*"
            });

            //define datasource for DropDown TimeZone
            var timeZoneDataSource = [
                                      { LookUpText: "(GMT) Casablanca, Monrovia", LookUpGUID: "CB1E631E-B55C-4206-9F0E-CDE63D7241CF"},
                                      { LookUpText: "(GMT+07:00) Bangkok, Hanoi, Jakarta", LookUpGUID: "4A372C96-6B63-48D4-B626-3DE55D72C7E7"},
                                      { LookUpText: "(GMT+08:00) Perth", LookUpGUID: "17D2ACE3-8D2B-4AAF-BB51-8CDF2F41031D"},
                                      { LookUpText: "(GMT+09:30) Darwin", LookUpGUID: "62E1E82A-9A96-4AAF-9E40-F31F364A4CC6"},
                                      { LookUpText: "(GMT+10:00) Brisbane", LookUpGUID: "01D59517-1B96-48D8-963A-CFBE8004CC36"}
                                  ];

            //assign combobox NoofDoctor with value from datasource
            $("#Reg2TimeZone").kendoDropDownList({
                dataSource: timeZoneDataSource,
                dataTextField: 'LookUpText',
                dataValueField: 'LookUpGUID',
                filter: "contains",
                suggest: true,
                optionLabel: "Time Zone*"
            });

            //define datasource for combobox Country
            var countryDataSource = [
                        { COUTRYTEXT: "Australia", COUNTRYVALUE: "AU"},
                        { COUTRYTEXT: "Indonesia", COUNTRYVALUE: "ID"},
                        { COUTRYTEXT: "Singapore", COUNTRYVALUE: "SG"}
                    ];

            //assign combobox Country with value from datasource
            $("#Country").kendoDropDownList({
                dataSource: countryDataSource,
                dataTextField: "COUTRYTEXT",
                dataValueField: "COUNTRYVALUE",
                filter: "contains",
                suggest: true
            });
           
            //assign combobox NoofDoctor with value from datasource
            $("#ServiceProviderType").kendoDropDownList({
                dataSource: ServiceProviderTypeDataSource,
                dataTextField: "LOOKUPTEXT",
                dataValueField: "LOOKUPGUID",
                filter: "contains",
                suggest: true,
                optionLabel: "Service Provider Type*"
            });
        };

        //Validating the form
        var validator = $("#RegistrationForm").kendoValidator({
            validateOnBlur: false
        }).data("kendoValidator");
        $("#Reg2Next").on("click", function () {
            var validatorType1 = validateCommonField($("#RegistrationForm"), "[class=RegInputWithValidation]");
            if (validator.validate() & validatorType1.validate()) {
                // If the form is valid, the Validator will return true
                saveRegistration2();
            }
            else {
                ChangeInvalidDropDownBorderColor();
            }
        });

        //Binding the information from Web API to form
        if (args.name == "registration2") { // check if this view was switched to
            var productModel = kendo.data.Model.define({ // we want to refresh this view anytime its switched to
                id: "UserID",
                fields: {
                    PracticeName: { type: "string", validation: { required: true} },
                    Phone: { type: "string", validation: { required: true} }
                }
            });

            var dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: function (data) {
                            return "rest/registration/getregistration/" + getRegId();
                        },
                        dataType: "json",
                        complete: function (jqXhr, textStatus) {
                            var result = jQuery.parseJSON(jqXhr.responseText);
                            //alert(result.opportunityGuid);
                            accountGuid = result.accountGuid;
                     	}
                    }
                },
                change: function (data) {
                    if (data.Success == false) {
                        $("#Message").text(data.Message);
                        $("#MessageModalDialog").dialog("open");
                    }
                },
                requestStart: function (e) {
                    $("#ProgressModalDialog").dialog("open");
                    $("#ProgressMessage").text("Loading your profile..")
                },
                requestEnd: function (e) {
                    $("#ProgressModalDialog").dialog("close");
                    LoadDropDownLists();                    
                },
                schema: {
                    type: "json",
                    model: productModel
                },
                error: function (e) {
                    var MRCustomErrorMessage = e.xhr.responseJSON.MRCustomErrorMessage;
                    var MRCustomErrorCode = e.xhr.responseJSON.MRCustomErrorCode;
                    if (MRCustomErrorCode == "MR00017") {
                        window.location = '/index.html#/accountexpired';
                    }
                    else if (MRCustomErrorCode == "MR00018") {
                        window.location = '/index.html#/accountnotfound';
                    }
                }
            });
            dataSource.fetch(function () {
                if (dataSource.view().length > 0) {
                    kendo.bind($("#RegistrationForm"), dataSource.at(0));
                }
            });
            $('#HiddenAccountID').val(getRegId());
        }
    });

    function saveRegistration2() {
        var suburbDropDownList = $("#CitySuburb").data("kendoDropDownList")
        var stateDropDownList = $("#State").data("kendoDropDownList")

        var registration2 = {
            CurrentClinicalSystem: $('#HiddenCurrentClinicalSystem').val(),
            Email: $('#HiddenEmail').val(),
            FirstName: $('#HiddenFirstName').val(),
            LastName: $('#HiddenLastName').val(),
            PromotionCode: $('#HiddenPromotionCode').val(),
            Title: $('#HiddenTitle').val(),
            UserId: $('#HiddenUserID').val(),
            ProviderTypeId: $('#ServiceProviderType').val(),
            Country: $('#Country').val(),
            CountryName: $("#Country").data("kendoDropDownList").text(),
            NumberOfDoctors: $('#NoofDoctor').val(),
            PracticeName: $('#PracticeName').val(),
            Address1: $('#Address1').val(),
            Address2: $('#Address2').val(),
            City: suburbDropDownList.text(),
            PostCode: $('#PostCode').val(),
            State: stateDropDownList.text(),
            Phone: $('#Phone').val(),
            AccountId: accountGuid,
            TimeZone: $('#Reg2TimeZone').val(),
            UserCategoryId: $('#HiddenUserCategoryId').val(),
            DoNotSendMM: $('#HiddenDoNotSendMM').val(),
            OpportunityGuid: $('#HiddenOpportunityGuid').val(),
            ContactGuid: $('#HiddenContactGuid').val()
        };
        $.cookie.json = true;
        $.cookie('registration2', registration2);
        window.location = 'registration.html#/registration3';
    };
</script>